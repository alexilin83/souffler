/* src\js\App.svelte generated by Svelte v3.35.0 */
import {
	SvelteComponent,
	action_destroyer,
	append,
	attr,
	binding_callbacks,
	detach,
	element,
	init,
	insert,
	listen,
	noop,
	run_all,
	safe_not_equal,
	set_input_value,
	space,
	to_number
} from "../../_snowpack/pkg/svelte/internal.js";

function create_else_block(ctx) {
	let div1;
	let canvas_1;
	let canvas_action;
	let t0;
	let div0;
	let input;
	let t1;
	let div2;
	let mounted;
	let dispose;

	return {
		c() {
			div1 = element("div");
			canvas_1 = element("canvas");
			t0 = space();
			div0 = element("div");
			input = element("input");
			t1 = space();
			div2 = element("div");
			div2.textContent = "Lorem ipsum dolor sit amet consectetur adipisicing elit. Dicta quas laudantium quaerat voluptas, laborum maxime dolore nostrum perferendis quam obcaecati aspernatur doloribus facere tempore dolorum doloremque. Quibusdam est sapiente, temporibus nam veniam hic enim facilis soluta! Nulla laudantium dolores non soluta eveniet! Beatae quidem, quis, in reiciendis id fuga quo esse, iure ullam dolorum ipsum fugit doloremque modi ab? Commodi accusamus totam maxime culpa natus ullam sit dolorum voluptatem ut. Adipisci, voluptates nobis dignissimos eos, nostrum similique non blanditiis alias facilis cumque ducimus neque recusandae reiciendis maxime possimus earum quia obcaecati quidem accusantium et ipsam. Natus sunt totam adipisci placeat iusto voluptate saepe cumque incidunt unde ratione temporibus nobis accusantium, animi labore mollitia modi quaerat harum inventore ullam ab, facilis consectetur, enim commodi! Doloribus nisi modi dolore voluptatibus in recusandae unde dignissimos qui neque dolorem accusamus tempore sint a, placeat nihil ipsum accusantium voluptatem enim quas, incidunt itaque quia adipisci commodi! Totam tempora autem, vitae corrupti enim ad laborum magnam. Doloribus qui, iste nobis facere omnis earum nisi quod. Tempore sequi, alias ipsum pariatur placeat, corporis sint adipisci sunt eveniet explicabo quibusdam. Neque, possimus amet similique mollitia, officia modi distinctio quae, quaerat dolore quo eligendi porro dolores inventore doloremque hic vero. Pariatur veniam ipsum iste dolorem perspiciatis eos ea, vel eaque necessitatibus sunt itaque amet ratione esse saepe perferendis neque dolor odio fugit dolores optio. Libero, reiciendis quia dolor distinctio velit earum! Autem, reprehenderit incidunt harum eius neque accusamus quibusdam, alias quidem excepturi libero saepe voluptatem est nostrum quasi asperiores doloribus in sapiente cumque molestiae? Inventore accusantium amet deserunt veritatis ducimus incidunt beatae tempora quae ipsum repellat voluptatem perspiciatis officia enim earum explicabo necessitatibus, adipisci natus reprehenderit harum nihil! Natus doloribus similique unde possimus quidem voluptate ipsam, expedita qui, nihil vitae cumque non at saepe cum. Nemo iste laudantium nostrum?";
			attr(input, "type", "range");
			attr(input, "min", "0");
			attr(input, "max", "200");
			attr(input, "step", "100");
			attr(div0, "class", "absolute top-0 right-0 p-2");
			attr(div1, "class", "relative w-full h-1/6 flex-initial bg-gray-500 text-white");
			attr(div2, "class", "w-full h-5/6 flex-initial overflow-y-auto p-4 xl:p-8 bg-gray-100 text-5xl xl:text-8xl");
		},
		m(target, anchor) {
			insert(target, div1, anchor);
			append(div1, canvas_1);
			append(div1, t0);
			append(div1, div0);
			append(div0, input);
			set_input_value(input, /*sensivity*/ ctx[2]);
			insert(target, t1, anchor);
			insert(target, div2, anchor);
			/*div2_binding*/ ctx[6](div2);

			if (!mounted) {
				dispose = [
					action_destroyer(canvas_action = /*canvas*/ ctx[4].call(null, canvas_1)),
					listen(input, "change", /*input_change_input_handler*/ ctx[5]),
					listen(input, "input", /*input_change_input_handler*/ ctx[5])
				];

				mounted = true;
			}
		},
		p(ctx, dirty) {
			if (dirty & /*sensivity*/ 4) {
				set_input_value(input, /*sensivity*/ ctx[2]);
			}
		},
		d(detaching) {
			if (detaching) detach(div1);
			if (detaching) detach(t1);
			if (detaching) detach(div2);
			/*div2_binding*/ ctx[6](null);
			mounted = false;
			run_all(dispose);
		}
	};
}

// (2:4) {#if !audioCtx}
function create_if_block(ctx) {
	let button;
	let mounted;
	let dispose;

	return {
		c() {
			button = element("button");
			button.textContent = "Начать";
			attr(button, "class", "absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 bg-red-500 px-4 py-2 text-white rounded-lg");
		},
		m(target, anchor) {
			insert(target, button, anchor);

			if (!mounted) {
				dispose = listen(button, "click", /*start*/ ctx[3]);
				mounted = true;
			}
		},
		p: noop,
		d(detaching) {
			if (detaching) detach(button);
			mounted = false;
			dispose();
		}
	};
}

function create_fragment(ctx) {
	let div;

	function select_block_type(ctx, dirty) {
		if (!/*audioCtx*/ ctx[0]) return create_if_block;
		return create_else_block;
	}

	let current_block_type = select_block_type(ctx, -1);
	let if_block = current_block_type(ctx);

	return {
		c() {
			div = element("div");
			if_block.c();
			attr(div, "class", "container mx-auto h-screen flex flex-wrap");
		},
		m(target, anchor) {
			insert(target, div, anchor);
			if_block.m(div, null);
		},
		p(ctx, [dirty]) {
			if (current_block_type === (current_block_type = select_block_type(ctx, dirty)) && if_block) {
				if_block.p(ctx, dirty);
			} else {
				if_block.d(1);
				if_block = current_block_type(ctx);

				if (if_block) {
					if_block.c();
					if_block.m(div, null);
				}
			}
		},
		i: noop,
		o: noop,
		d(detaching) {
			if (detaching) detach(div);
			if_block.d();
		}
	};
}

function instance($$self, $$props, $$invalidate) {
	let audioCtx;
	let analyser;
	let source;
	let text;
	let canvasCtx;
	let WIDTH;
	let HEIGHT;
	let drawVisual;
	let bufferLengthAlt;
	let dataArrayAlt;
	let volume;
	let sensivity = 100;

	function start() {
		$$invalidate(0, audioCtx = new (window.AudioContext || window.webkitAudioContext)());
		analyser = audioCtx.createAnalyser();

		navigator.mediaDevices.getUserMedia({ video: false, audio: true }).then(function (stream) {
			source = audioCtx.createMediaStreamSource(stream);
			source.connect(analyser);
			visualize();
		}).catch(function (err) {
			console.error(err);
		});
	}

	function canvas(node) {
		canvasCtx = node.getContext("2d");
		node.setAttribute("width", node.parentNode.clientWidth);
		node.setAttribute("height", node.parentNode.clientHeight);
		WIDTH = node.parentNode.clientWidth;
		HEIGHT = node.parentNode.clientHeight;
	}

	function visualize() {
		analyser.fftSize = 256;
		analyser.minDecibels = -90;
		analyser.maxDecibels = -10;
		analyser.smoothingTimeConstant = 0.85;
		bufferLengthAlt = analyser.frequencyBinCount;
		dataArrayAlt = new Uint8Array(bufferLengthAlt);
		canvasCtx.clearRect(0, 0, WIDTH, HEIGHT);
		draw();
	}

	function draw() {
		drawVisual = requestAnimationFrame(draw);
		analyser.getByteFrequencyData(dataArrayAlt);
		canvasCtx.fillStyle = "rgb(0, 0, 0)";
		canvasCtx.fillRect(0, 0, WIDTH, HEIGHT);
		let barWidth = WIDTH / bufferLengthAlt * 2.5;
		let barHeight;
		let x = 0;

		for (let i = 0; i < bufferLengthAlt; i++) {
			barHeight = dataArrayAlt[i];
			canvasCtx.fillStyle = `rgb(127, ${barHeight + 100}, 0)`;
			canvasCtx.fillRect(x, HEIGHT - barHeight / 2, barWidth, barHeight / 2);
			x += barWidth + 1;
		}

		volume = Math.max(...dataArrayAlt) / 256;

		if (volume > 0.4) {
			$$invalidate(1, text.scrollTop += 1 + 1 * sensivity / 100, text);
		}
	}

	function input_change_input_handler() {
		sensivity = to_number(this.value);
		$$invalidate(2, sensivity);
	}

	function div2_binding($$value) {
		binding_callbacks[$$value ? "unshift" : "push"](() => {
			text = $$value;
			$$invalidate(1, text);
		});
	}

	return [
		audioCtx,
		text,
		sensivity,
		start,
		canvas,
		input_change_input_handler,
		div2_binding
	];
}

class App extends SvelteComponent {
	constructor(options) {
		super();
		init(this, options, instance, create_fragment, safe_not_equal, {});
	}
}

export default App;